let frameCount = 0;
let lastDetected = null;
let lastDetectedTime = 0;

function scanFrame() {
  if (video.readyState === video.HAVE_ENOUGH_DATA) {
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

    // Try QR every frame (fast)
    const qr = jsQR(imageData.data, canvas.width, canvas.height);
    if (qr) {
      lastDetected = "QR: " + qr.data;
      lastDetectedTime = Date.now();
    } else {
      // Only run Quagga every 10th frame
      if (frameCount % 10 === 0) {
        Quagga.decodeSingle({
          src: canvas.toDataURL(),
          numOfWorkers: 0,
          inputStream: { size: canvas.width },
          decoder: { readers: ["code_128_reader","ean_reader","upc_reader","code_39_reader"] }
        }, function(result) {
          if (result && result.codeResult) {
            lastDetected = "Barcode: " + result.codeResult.code;
            lastDetectedTime = Date.now();
          }
        });
      }
    }
  }

  // Update UI: keep last detection for 2 seconds
  if (lastDetected && Date.now() - lastDetectedTime < 2000) {
    resultBox.textContent = lastDetected;
  } else {
    resultBox.textContent = "No barcode found.";
  }

  frameCount++;
  requestAnimationFrame(scanFrame);
}
requestAnimationFrame(scanFrame);